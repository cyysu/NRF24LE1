C51 COMPILER V9.52.0.0   MAIN                                                              04/21/2015 09:03:18 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Object\main.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c LARGE BROWSE INCDIR(hal\nrf24le1;hal;hal\nrf24l01p;compiler\common;c
                    -ompiler\c51) DEBUG OBJECTEXTEND PRINT(.\lst\main.lst) TABS(2) OBJECT(.\Object\main.obj)

line level    source

   1          /****************************************Copyright (c)****************************************************
   2          **                                        
   3          **                                 
   4          **
   5          **--------------File Info---------------------------------------------------------------------------------
   6          ** File name:     main.c
   7          ** Last modified Date: 2015-4-16         
   8          ** Last Version:    1.2
   9          ** Descriptions:              
  10          **--------------------------------------------------------------------------------------------------------
  11          ** Created by:      FiYu
  12          ** Created date:    2014-11-12
  13          ** Version:         1.0
  14          ** Descriptions:    FLASH读写实验程序     
  15          **--------------------------------------------------------------------------------------------------------
  16          ** Modified by:     FiYu
  17          ** Modified date:   
  18          ** Version:       
  19          ** Descriptions:    
  20          ** Rechecked by:      
  21          **********************************************************************************************************
             -/
  22          #include <stdio.h> 
  23          #include <reg24le1.h>
  24          #include <stdint.h>
  25          #include "hal_uart.h"
  26          #include "hal_clk.h"
  27          #include "hal_delay.h"
  28          #include "hal_flash.h"
  29          #include "HAL_FLASH_HW.h"
  30          
  31          /*-------------------管脚定义--------------------------------------------------*/
  32          #define  D1    P00  // 开发板上的指示灯D1
  33          #define  D2    P01  // 开发板上的指示灯D2
  34          #define  S1    P12  // 开发板上的按键S1
  35          #define  S2    P13  // 开发板上的按键S2
  36          
  37          
  38          /* 开发板中nRF24LE1管脚配置
  39          P00：输出，驱动D1        P12：输入，按键检测S1  
  40          P01：输出，驱动D2        P13：输入，按键检测S2
  41          P02：输出，OLED时钟      P14：输出，OLED数据
  42          P03：输出，UART TXD      P15：输出，OLED片选
  43          P04：输入，UART RXD      P16：输出，OLED命令/数据选择
  44          P06：输入，AIN6  AD检测  蜂鸣器驱动(通过跳线选择)
  45          */
  46          
  47          uint8_t idata WriteBuf[5];
  48          uint8_t idata temp_data[5];
  49          
  50          /*******************************************************************************************************
  51           * 描  述 : 配置 IO P0.0和P0.1为输出PP03：输出,作为UART TXD，P04：输入,作为UART RXD
  52           * 入  参 : 无
  53           * 返回值 : 无
C51 COMPILER V9.52.0.0   MAIN                                                              04/21/2015 09:03:18 PAGE 2   

  54           *******************************************************************************************************/
  55          void IO_Init(void)
  56          { 
  57   1        P0DIR &= ~0x03;    //配置P0.0和P0.1为输出
  58   1        P0DIR &= ~0x08;    //P03：输出，UART TXD
  59   1        P0DIR |= 0x10;     //P04：输入，UART RXD  
  60   1        D1 = 1;            //设置D4初始状态为熄灭
  61   1        D2 = 1;            //设置D5初始状态为熄灭
  62   1      }
  63          
  64          /*******************************************************************************************************
  65           * 描  述 : 串口打印16进制字符
  66           * 入  参 : 输出的字符
  67           * 返回值 : 无
  68           *******************************************************************************************************/
  69          void PutHexString (uint8_t x)
  70          {
  71   1        uint8_t c;
  72   1      
  73   1        c = (x>>4)& 0xf;
  74   1        if (c > 9)
  75   1          hal_uart_putchar('A'+c-10);
  76   1        else
  77   1          hal_uart_putchar('0'+c);
  78   1      
  79   1          c = x & 0xf;
  80   1        if (c > 9)
  81   1          hal_uart_putchar('A'+c-10);
  82   1        else
  83   1         hal_uart_putchar('0'+c);
  84   1      }
  85          
  86          /*******************************************************************************************************
  87           * 描  述 : 串口输出字符串
  88           * 入  参 : 无
  89           * 返回值 : 无
  90           *******************************************************************************************************/
  91          void PutString(char *s)
  92          {
  93   1        while(*s != 0)
  94   1          hal_uart_putchar(*s++);
  95   1      }
  96          
  97          /*******************************************************************************************************
  98           * 描  述 :向FLASH中写入多个字节数据
  99           * 入  参 : a:起始地址  *p:写入的数据存放地址 n:写入的字节数
 100           * 返回值 : 无
 101           *******************************************************************************************************/
 102          void flash_bytes_write(uint16_t a, const uint8_t *p, uint16_t n)
 103          {
 104   1        uint8_t xdata *pb;
 105   1        
 106   1        F0 = EA; //保存中断设置
 107   1        EA = 0;  //关闭中断
 108   1      
 109   1        WEN = 1;//使能flash写操作
 110   1      
 111   1        pb = (uint8_t xdata *)a; 
 112   1        
 113   1        while(n--)
 114   1        {
 115   2          PCON |= 0x10;//置位pmw，使能对FLASH的访问
C51 COMPILER V9.52.0.0   MAIN                                                              04/21/2015 09:03:18 PAGE 3   

 116   2          *pb = *p;    //写入一字节数据
 117   2          PCON &= ~0x10;//清除pmw，关闭对FLASH的访问
 118   2      
 119   2          pb++;
 120   2          p++;
 121   2      
 122   2          while(RDYN == 1)//等待操作完成
 123   2            ;
 124   2        }
 125   1      
 126   1        WEN = 0;
 127   1      
 128   1        EA = F0; // Restore interrupt enable state
 129   1      }
 130          
 131          /*******************************************************************************************************
 132           * 描  述 : 从FLASH中读出多个字节数据
 133           * 入  参 : a:起始地址  *p:数据存放地址 n:读出的字节数
 134           * 返回值 : 无
 135           *******************************************************************************************************/
 136          void flash_bytes_read(uint16_t a, uint8_t *p, uint16_t n)
 137          {  
 138   1        uint8_t xdata *pb = (uint8_t xdata *)a;
 139   1        
 140   1        while(n--)
 141   1        {
 142   2          PCON |= 0x10;  //置位pmw，使能对FLASH的访问
 143   2          *p = *pb;      //读出一字节数据
 144   2          PCON &= ~0x10; //清除pmw，关闭对FLASH的访问
 145   2      
 146   2          pb++;
 147   2          p++;
 148   2        }
 149   1      }
 150          
 151          /*******************************************************************************************************
 152           * 描  述 : 主函数
 153           * 入  参 : 无
 154           * 返回值 : 无
 155           *******************************************************************************************************/
 156          void main(void)
 157          { 
 158   1        uint8_t i;
 159   1        uint32_t LoopCount = 0;
 160   1      
 161   1        hal_clk_set_16m_source(HAL_CLK_XOSC16M);            //使用外部16MHz晶振
 162   1      
 163   1        IO_Init();  //配置IO  
 164   1        hal_uart_init(UART_BAUD_57K6); // 初始化UART0                     
 165   1        while(hal_clk_get_16m_source() != HAL_CLK_XOSC16M) //等待时钟稳定
 166   1        ;  
 167   1          
 168   1        EA = 1;// 使能全局中断
 169   1      
 170   1        while(1)
 171   1        { 
 172   2          LoopCount++;
 173   2          if(LoopCount == 10000) //D4闪烁指示程序正常运行
 174   2          {
 175   3            D1 = ~D1;
 176   3            LoopCount = 0;
 177   3          }
C51 COMPILER V9.52.0.0   MAIN                                                              04/21/2015 09:03:18 PAGE 4   

 178   2          if(S1 == 0)
 179   2          {
 180   3            delay_ms(10);
 181   3            
 182   3            if(S1 == 0)   //按键S1按下
 183   3            {
 184   4              hal_flash_page_erase(20); //写之前先擦除
 185   4              delay_ms(30);
 186   4              for(i=0;i<5;i++) WriteBuf[i] = i+1;
 187   4              flash_bytes_write(0x2800,WriteBuf,5); //写入数据
 188   4              flash_bytes_read(0x2800,temp_data,5); //读出数据
 189   4              PutString("Flash address 0x2800~0x2804:"); //串口打印出0x2800~0x2804上的数据
 190   4              for(i=0;i<5;i++)PutHexString(temp_data[i]);
 191   4              while(S1==0); //等待按键释放
 192   4            }
 193   3          }  
 194   2        }
 195   1      }
 196           /*********************************END FILE***************************************************************
             -*/  


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    470    ----
   CONSTANT SIZE    =     29    ----
   XDATA SIZE       =   ----      24
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =     10    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
