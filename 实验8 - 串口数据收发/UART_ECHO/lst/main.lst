C51 COMPILER V9.52.0.0   MAIN                                                              04/29/2015 09:13:15 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Object\main.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c LARGE BROWSE INCDIR(hal\nrf24le1;hal;compiler\c51;compiler\common) D
                    -EBUG OBJECTEXTEND PRINT(.\lst\main.lst) TABS(2) OBJECT(.\Object\main.obj)

line level    source

   1          /****************************************Copyright (c)****************************************************
   2          **                                        
   3          **                                 
   4          **
   5          **--------------File Info---------------------------------------------------------------------------------
   6          ** File name:     main.c
   7          ** Last modified Date: 2015-4-16         
   8          ** Last Version:    1.2
   9          ** Descriptions:              
  10          **--------------------------------------------------------------------------------------------------------
  11          ** Created by:      FiYu
  12          ** Created date:    2014-11-12
  13          ** Version:         1.0
  14          ** Descriptions:    UART数据收发实验    
  15          **--------------------------------------------------------------------------------------------------------
  16          ** Modified by:     FiYu
  17          ** Modified date:   
  18          ** Version:       
  19          ** Descriptions:    
  20          ** Rechecked by:      
  21          **********************************************************************************************************
             -/
  22          #include <stdio.h> 
  23          #include <reg24le1.h>
  24          #include <stdint.h>
  25          #include "hal_uart.h"
  26          #include "hal_clk.h"
  27          #include "hal_delay.h"
  28          
  29          
  30          /*-------------------管脚定义--------------------------------------------------*/
  31          #define  D1    P00  // 开发板上的指示灯D1
  32          
  33          #define BAUD_57K6   1015  // = Round(1024 - (2*16e6)/(64*57600))
  34          #define BAUD_38K4   1011  // = Round(1024 - (2*16e6)/(64*38400))
  35          #define BAUD_19K2    998  // = Round(1024 - (2*16e6)/(64*19200))
  36          #define BAUD_9K6     972  // = Round(1024 - (2*16e6)/(64*9600))
  37          
  38          
  39          /* 开发板中nRF24LE1管脚配置
  40          P00：输出，驱动D1        P12：输入，按键检测S1  
  41          P01：输出，驱动D2        P13：输入，按键检测S2
  42          P02：输出，OLED时钟      P14：输出，OLED数据
  43          P03：输出，UART TXD      P15：输出，OLED片选
  44          P04：输入，UART RXD      P16：输出，OLED命令/数据选择
  45          P06：输入，AIN6  AD检测  蜂鸣器驱动(通过跳线选择)
  46          */
  47          
  48          
  49          /*******************************************************************************************************
  50           * 描  述 : 配置 IO P0.0和P0.1为输出PP03：输出,作为UART TXD，P04：输入,作为UART RXD
  51           * 入  参 : 无
  52           * 返回值 : 无
  53           *******************************************************************************************************/
C51 COMPILER V9.52.0.0   MAIN                                                              04/29/2015 09:13:15 PAGE 2   

  54          void IO_Init(void)
  55          { 
  56   1        P0DIR &= ~0x01;    //配置P0.0和P0.1为输出
  57   1        P0DIR &= ~0x08;    //P03：输出，UART TXD
  58   1        P0DIR |= 0x10;     //P04：输入，UART RXD  
  59   1        D1 = 1;            //设置D1初始状态为熄灭
  60   1      }
  61          
  62          /*******************************************************************************************************
  63           * 描  述 : 串口初始化
  64           * 入  参 : 无
  65           * 返回值 : 无
  66           *******************************************************************************************************/
  67          void uart_init(uint16_t baud)
  68          { 
  69   1        S0CON = 0x50;     //8位UART
  70   1        PCON |= 0x80;     // SMOD = 1
  71   1        ADCON |= 0x80;    // 使用内部波特率发生器   
  72   1      
  73   1        S0RELL = (uint8_t)baud;  //设置波特率
  74   1        S0RELH = (uint8_t)(baud >> 8);
  75   1      }
  76          
  77          /*******************************************************************************************************
  78           * 描  述 : 串口输出字符
  79           * 入  参 : 无
  80           * 返回值 : 无
  81           *******************************************************************************************************/
  82          void uart_sendchar(uint8_t dat)
  83          {
  84   1        S0BUF = dat;
  85   1        while(!TI0);
  86   1        TI0 = 0;
  87   1      }
  88          
  89          /*******************************************************************************************************
  90           * 描  述 : 串口输出字符串
  91           * 入  参 : 无
  92           * 返回值 : 无
  93           *******************************************************************************************************/
  94          void PutString(char *s)
  95          {
  96   1        while(*s != 0)
  97   1          uart_sendchar(*s++);
  98   1      }
  99          
 100          /*******************************************************************************************************
 101           * 描  述 : 主函数
 102           * 入  参 : 无
 103           * 返回值 : 无
 104           *******************************************************************************************************/
 105          void main(void)
 106          { 
 107   1        uint32_t loopcount = 0;
 108   1        uint8_t temp_char;
 109   1        
 110   1        IO_Init();  //配置IO
 111   1      
 112   1        uart_init(BAUD_57K6);                    
 113   1      
 114   1        while(hal_clk_get_16m_source() != HAL_CLK_XOSC16M) //等待时钟稳定
 115   1        ;
C51 COMPILER V9.52.0.0   MAIN                                                              04/29/2015 09:13:15 PAGE 3   

 116   1       
 117   1        EA = 1;  // 使能全局中断                                           
 118   1        PutString("Welcome to FiYu!\n");
 119   1      
 120   1        while(1)
 121   1        {
 122   2          loopcount++;
 123   2          if(loopcount == 15000)  // D1闪烁，指示设备工作正常
 124   2          {
 125   3            loopcount = 0;
 126   3            D1 = ~D1;
 127   3          }
 128   2          
 129   2          if(RI0==1)//UART接收到数据 
 130   2          {  
 131   3            temp_char = S0BUF; //读取数据
 132   3            RI0 = 0;
 133   3            S0BUF = temp_char; //返回接收的数据
 134   3            while(!TI0);
 135   3            TI0=0;
 136   3          }
 137   2        }
 138   1      }
 139          /*********************************END FILE****************************************************************
             -/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    209    ----
   CONSTANT SIZE    =     18    ----
   XDATA SIZE       =   ----       7
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
